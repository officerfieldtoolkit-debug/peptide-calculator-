import{q as ue,r as p,j as e,L as F,R as pe}from"./vendor-CkzOwYxW.js";import{s as i,u as me}from"./index-CkrV_KEF.js";import{p as I,a1 as L,M as S,a7 as he,ad as Y,h as R,aE as J,F as E,i as Z,l as M,aB as _e,t as xe,an as ee,X as ge,aF as ye,aG as fe,B as je,aH as Ne,y as we,d as ve,av as Ce}from"./icons-CxzY2V_d.js";import"./charts-CXyhUZZ_.js";const y={async getCategories(){const{data:a,error:o}=await i.from("forum_categories").select("*").order("sort_order");if(o)throw o;return a},async getCategoryWithTopics(a,o=1,c=20){const r=(o-1)*c,{data:l,error:d}=await i.from("forum_categories").select("*").eq("slug",a).single();if(d)throw d;let _=[],m=0;try{const{data:h,error:u,count:f}=await i.from("forum_topics_with_profiles").select("*",{count:"exact"}).eq("category_id",l.id).order("is_pinned",{ascending:!1}).order("created_at",{ascending:!1}).range(r,r+c-1);if(!u)_=h||[],m=f||0;else throw u}catch{const{data:u,error:f,count:w}=await i.from("forum_topics").select("*",{count:"exact"}).eq("category_id",l.id).order("is_pinned",{ascending:!1}).order("created_at",{ascending:!1}).range(r,r+c-1);if(f)throw f;_=(u||[]).map(v=>({...v,full_name:null})),m=w||0}return{category:l,topics:_,totalCount:m}},async getTopic(a){await i.rpc("increment_topic_views",{topic_id:a}).catch(()=>{});try{const{data:l,error:d}=await i.from("forum_topics_with_profiles").select("*").eq("id",a).single();if(!d&&l){const{data:_}=await i.from("forum_categories").select("name, slug").eq("id",l.category_id).single();return{...l,category:_}}}catch{}const{data:o,error:c}=await i.from("forum_topics").select("*").eq("id",a).single();if(c)throw c;const{data:r}=await i.from("forum_categories").select("name, slug").eq("id",o.category_id).single();return{...o,category:r,full_name:null}},async getTopicPosts(a,o=1,c=20){const r=(o-1)*c;try{const{data:m,error:h,count:u}=await i.from("forum_posts_with_profiles").select("*",{count:"exact"}).eq("topic_id",a).order("created_at",{ascending:!0}).range(r,r+c-1);if(!h)return{posts:m||[],totalCount:u||0}}catch{}const{data:l,error:d,count:_}=await i.from("forum_posts").select("*",{count:"exact"}).eq("topic_id",a).order("created_at",{ascending:!0}).range(r,r+c-1);if(d)throw d;return{posts:(l||[]).map(m=>({...m,full_name:null})),totalCount:_||0}},async createTopic(a,o,c){const{data:{user:r}}=await i.auth.getUser();if(!r)throw new Error("Not authenticated");const{data:l,error:d}=await i.from("forum_topics").insert({category_id:a,user_id:r.id,title:o,content:c}).select().single();if(d)throw d;return l},async updateTopic(a,o,c){const{data:r,error:l}=await i.from("forum_topics").update({title:o,content:c,updated_at:new Date().toISOString()}).eq("id",a).select().single();if(l)throw l;return r},async deleteTopic(a){const{error:o}=await i.from("forum_topics").delete().eq("id",a);if(o)throw o;return!0},async createPost(a,o){const{data:{user:c}}=await i.auth.getUser();if(!c)throw new Error("Not authenticated");const{data:r,error:l}=await i.from("forum_posts").insert({topic_id:a,user_id:c.id,content:o}).select("*").single();if(l)throw l;return r},async updatePost(a,o){const{data:c,error:r}=await i.from("forum_posts").update({content:o,updated_at:new Date().toISOString()}).eq("id",a).select().single();if(r)throw r;return c},async deletePost(a){const{error:o}=await i.from("forum_posts").delete().eq("id",a);if(o)throw o;return!0},async markAsSolution(a,o=!0){const{data:c,error:r}=await i.from("forum_posts").update({is_solution:o}).eq("id",a).select().single();if(r)throw r;return c},async toggleLike(a=null,o=null){const{data:{user:c}}=await i.auth.getUser();if(!c)throw new Error("Not authenticated");let r=i.from("forum_likes").select("id").eq("user_id",c.id);a&&(r=r.eq("topic_id",a)),o&&(r=r.eq("post_id",o));const{data:l}=await r.single();return l?(await i.from("forum_likes").delete().eq("id",l.id),!1):(await i.from("forum_likes").insert({user_id:c.id,topic_id:a,post_id:o}),!0)},async getLikeCounts(a){const{count:o}=await i.from("forum_likes").select("*",{count:"exact",head:!0}).eq("topic_id",a);return{topicLikes:o||0}},async searchTopics(a,o=20){try{const{data:l,error:d}=await i.from("forum_topics_with_profiles").select("*").or(`title.ilike.%${a}%,content.ilike.%${a}%`).order("created_at",{ascending:!1}).limit(o);if(!d)return l||[]}catch{}const{data:c,error:r}=await i.from("forum_topics").select("*").or(`title.ilike.%${a}%,content.ilike.%${a}%`).order("created_at",{ascending:!1}).limit(o);if(r)throw r;return c||[]},async getRecentTopics(a=10){try{const{data:r,error:l}=await i.from("forum_topics_with_profiles").select("*").order("created_at",{ascending:!1}).limit(a);if(!l&&r){const d=[...new Set(r.map(h=>h.category_id))],{data:_}=await i.from("forum_categories").select("id, name, slug, color").in("id",d),m=(_||[]).reduce((h,u)=>({...h,[u.id]:u}),{});return r.map(h=>({...h,category:m[h.category_id]}))}}catch{}const{data:o,error:c}=await i.from("forum_topics").select("*").order("created_at",{ascending:!1}).limit(a);if(c)throw c;return o||[]},async getForumStats(){const{count:a}=await i.from("forum_topics").select("*",{count:"exact",head:!0}),{count:o}=await i.from("forum_posts").select("*",{count:"exact",head:!0});return{topics:a||0,posts:o||0}}},Se="_container_p8xud_1",Be="_header_p8xud_8",Te="_statsBar_p8xud_29",be="_stat_p8xud_29",ke="_actions_p8xud_55",Pe="_searchBox_p8xud_62",ze="_searchIcon_p8xud_88",De="_newTopicBtn_p8xud_96",qe="_categoriesGrid_p8xud_116",Fe="_categoryCard_p8xud_123",Ie="_categoryHeader_p8xud_140",Le="_categoryIcon_p8xud_147",Re="_categoryName_p8xud_157",Ee="_categoryDesc_p8xud_163",Me="_categoryStats_p8xud_170",Ae="_recentSection_p8xud_178",He="_topicsList_p8xud_189",$e="_topicCard_p8xud_195",Ge="_topicHeader_p8xud_211",Ue="_topicTitle_p8xud_219",We="_pinnedBadge_p8xud_228",Oe="_topicCategory_p8xud_237",Qe="_topicMeta_p8xud_245",Ke="_topicStats_p8xud_253",Ve="_topicStat_p8xud_253",Xe="_categoryPage_p8xud_294",Ye="_breadcrumb_p8xud_298",Je="_categoryTitle_p8xud_316",Ze="_topicPage_p8xud_330",et="_topicContent_p8xud_335",tt="_topicAuthor_p8xud_343",st="_avatar_p8xud_350",at="_authorInfo_p8xud_363",ot="_authorName_p8xud_367",rt="_authorDate_p8xud_372",ct="_topicBody_p8xud_377",it="_topicActions_p8xud_387",nt="_actionBtn_p8xud_396",lt="_repliesSection_p8xud_422",dt="_replyCard_p8xud_433",ut="_solution_p8xud_441",pt="_solutionBadge_p8xud_446",mt="_replyForm_p8xud_460",ht="_submitReply_p8xud_493",_t="_modal_p8xud_518",xt="_modalContent_p8xud_530",gt="_modalHeader_p8xud_540",yt="_closeBtn_p8xud_554",ft="_modalBody_p8xud_568",jt="_formGroup_p8xud_572",Nt="_modalFooter_p8xud_607",wt="_cancelBtn_p8xud_615",vt="_submitBtn_p8xud_629",Ct="_emptyState_p8xud_654",St="_loading_p8xud_672",Bt="_loginPrompt_p8xud_694",t={container:Se,header:Be,statsBar:Te,stat:be,actions:ke,searchBox:Pe,searchIcon:ze,newTopicBtn:De,categoriesGrid:qe,categoryCard:Fe,categoryHeader:Ie,categoryIcon:Le,categoryName:Re,categoryDesc:Ee,categoryStats:Me,recentSection:Ae,topicsList:He,topicCard:$e,topicHeader:Ge,topicTitle:Ue,pinnedBadge:We,topicCategory:Oe,topicMeta:Qe,topicStats:Ke,topicStat:Ve,categoryPage:Xe,breadcrumb:Ye,categoryTitle:Je,topicPage:Ze,topicContent:et,topicAuthor:tt,avatar:st,authorInfo:at,authorName:ot,authorDate:rt,topicBody:ct,topicActions:it,actionBtn:nt,repliesSection:lt,replyCard:dt,solution:ut,solutionBadge:pt,replyForm:mt,submitReply:ht,modal:_t,modalContent:xt,modalHeader:gt,closeBtn:yt,modalBody:ft,formGroup:jt,modalFooter:Nt,cancelBtn:wt,submitBtn:vt,emptyState:Ct,loading:St,loginPrompt:Bt},Tt={MessageCircle:S,Beaker:Ce,TrendingUp:ve,Shield:we,ShoppingBag:Ne,BookOpen:je,HelpCircle:fe,Coffee:ye},bt=()=>{const{user:a}=me();ue();const[o,c]=p.useState("categories"),[r,l]=p.useState([]),[d,_]=p.useState(null),[m,h]=p.useState([]),[u,f]=p.useState(null),[w,v]=p.useState([]),[A,H]=p.useState([]),[$,G]=p.useState({topics:0,posts:0}),[te,j]=p.useState(!0),[z,se]=p.useState(""),[kt,U]=p.useState([]),[ae,N]=p.useState(!1),[x,C]=p.useState({categoryId:"",title:"",content:""}),[B,W]=p.useState(""),[T,b]=p.useState(!1),[k,O]=p.useState(null);p.useEffect(()=>{Q()},[]);const Q=async()=>{try{j(!0),O(null);const[s,n,g]=await Promise.all([y.getCategories(),y.getRecentTopics(10),y.getForumStats()]);l(s||[]),H(n||[]),G(g||{topics:0,posts:0})}catch(s){console.error("Error loading forum data:",s),O(s.message||"Failed to load forum data"),l([]),H([]),G({topics:0,posts:0})}finally{j(!1)}},K=async s=>{try{j(!0);const{category:n,topics:g}=await y.getCategoryWithTopics(s);_(n),h(g||[]),c("category")}catch(n){console.error("Error loading category:",n);const g=r.find(q=>q.slug===s);_(g),h([]),c("category")}finally{j(!1)}},D=async s=>{try{j(!0);const[n,g]=await Promise.all([y.getTopic(s),y.getTopicPosts(s)]);f(n),v(g.posts||[]),c("topic")}catch(n){console.error("Error loading topic:",n);const g=m.find(q=>q.id===s);g?(f(g),v([]),c("topic")):c("categories")}finally{j(!1)}},oe=async()=>{if(!z.trim()){U([]);return}try{const s=await y.searchTopics(z);U(s||[])}catch(s){console.error("Error searching:",s)}},re=async s=>{if(s.preventDefault(),!!a)try{b(!0);const n=await y.createTopic(x.categoryId,x.title,x.content);N(!1),C({categoryId:"",title:"",content:""}),D(n.id)}catch(n){console.error("Error creating topic:",n),alert("Failed to create topic. Please try again.")}finally{b(!1)}},ce=async s=>{if(s.preventDefault(),!(!a||!B.trim()))try{b(!0);const n=await y.createPost(u.id,B);v([...w,n]),W("")}catch(n){console.error("Error posting reply:",n),alert("Failed to post reply. Please try again.")}finally{b(!1)}},P=s=>{const n=Math.floor((new Date-new Date(s))/1e3);return n<60?"just now":n<3600?`${Math.floor(n/60)}m ago`:n<86400?`${Math.floor(n/3600)}h ago`:n<604800?`${Math.floor(n/86400)}d ago`:new Date(s).toLocaleDateString()},V=s=>s?s.split(" ").map(n=>n[0]).join("").toUpperCase().slice(0,2):"U",X=s=>Tt[s]||S,ie=()=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:t.header,children:[e.jsx("h1",{children:"Community Forum"}),e.jsx("p",{children:"Connect with the peptide community, share experiences, and learn together"})]}),e.jsxs("div",{className:t.statsBar,children:[e.jsxs("div",{className:t.stat,children:[e.jsx(L,{size:18}),e.jsx("span",{children:$.topics})," Topics"]}),e.jsxs("div",{className:t.stat,children:[e.jsx(S,{size:18}),e.jsx("span",{children:$.posts})," Posts"]}),e.jsxs("div",{className:t.stat,children:[e.jsx(he,{size:18}),e.jsx("span",{children:"Active Community"})]})]}),e.jsxs("div",{className:t.actions,children:[e.jsxs("div",{className:t.searchBox,children:[e.jsx(Y,{size:18,className:t.searchIcon}),e.jsx("input",{type:"text",placeholder:"Search topics...",value:z,onChange:s=>se(s.target.value),onKeyDown:s=>s.key==="Enter"&&oe()})]}),a?e.jsxs("button",{className:t.newTopicBtn,onClick:()=>N(!0),children:[e.jsx(R,{size:18}),"New Topic"]}):e.jsxs(F,{to:"/login",className:t.newTopicBtn,children:[e.jsx(R,{size:18}),"Login to Post"]})]}),e.jsx("div",{className:t.categoriesGrid,children:r.length>0?r.map(s=>{const n=X(s.icon);return e.jsxs("div",{className:t.categoryCard,onClick:()=>K(s.slug),children:[e.jsxs("div",{className:t.categoryHeader,children:[e.jsx("div",{className:t.categoryIcon,style:{background:`${s.color}20`,color:s.color},children:e.jsx(n,{size:22})}),e.jsx("span",{className:t.categoryName,children:s.name})]}),e.jsx("p",{className:t.categoryDesc,children:s.description}),e.jsxs("div",{className:t.categoryStats,children:[e.jsx("span",{children:"Topics: --"}),e.jsx("span",{children:"Posts: --"})]})]},s.id)}):e.jsxs("div",{className:t.emptyState,style:{gridColumn:"1 / -1"},children:[e.jsx(S,{size:48}),e.jsx("h3",{children:k?"Unable to Load Forum":"Forum Coming Soon"}),e.jsx("p",{children:k?`Error: ${k}. Please try again later.`:"The community forum is being set up. Check back soon to join the discussion!"}),k&&e.jsx("button",{className:t.newTopicBtn,onClick:Q,style:{marginTop:"1rem",width:"auto"},children:"Retry"})]})}),A.length>0&&e.jsxs("div",{className:t.recentSection,children:[e.jsx("h2",{children:"Recent Discussions"}),e.jsx("div",{className:t.topicsList,children:A.map(s=>e.jsxs("div",{className:t.topicCard,onClick:()=>D(s.id),children:[e.jsxs("div",{className:t.topicHeader,children:[e.jsxs("span",{className:t.topicTitle,children:[s.is_pinned&&e.jsxs("span",{className:t.pinnedBadge,children:[e.jsx(J,{size:10})," Pinned"]}),s.title]}),s.category&&e.jsx("span",{className:t.topicCategory,style:{background:`${s.category.color}20`,color:s.category.color},children:s.category.name})]}),e.jsxs("div",{className:t.topicMeta,children:[e.jsxs("span",{children:["by ",s.author?.full_name||"Anonymous"]}),e.jsxs("span",{className:t.topicStats,children:[e.jsxs("span",{className:t.topicStat,children:[e.jsx(E,{size:14})," ",s.view_count||0]}),e.jsxs("span",{className:t.topicStat,children:[e.jsx(L,{size:14})," ",s.posts?.[0]?.count||0]}),e.jsxs("span",{className:t.topicStat,children:[e.jsx(Z,{size:14})," ",P(s.created_at)]})]})]})]},s.id))})]})]}),ne=()=>e.jsxs("div",{className:t.categoryPage,children:[e.jsxs("div",{className:t.breadcrumb,children:[e.jsx("a",{href:"#",onClick:s=>{s.preventDefault(),c("categories")},children:"Forum"}),e.jsx(M,{size:14}),e.jsx("span",{children:d?.name})]}),e.jsxs("div",{className:t.categoryTitle,children:[d&&e.jsx("div",{className:t.categoryIcon,style:{background:`${d.color}20`,color:d.color},children:pe.createElement(X(d.icon),{size:28})}),e.jsx("h1",{children:d?.name})]}),e.jsx("p",{style:{color:"var(--text-secondary)",marginBottom:"1.5rem"},children:d?.description}),e.jsxs("div",{className:t.actions,children:[e.jsxs("div",{className:t.searchBox,children:[e.jsx(Y,{size:18,className:t.searchIcon}),e.jsx("input",{type:"text",placeholder:"Search in this category..."})]}),a?e.jsxs("button",{className:t.newTopicBtn,onClick:()=>{C({...x,categoryId:d?.id}),N(!0)},children:[e.jsx(R,{size:18}),"New Topic"]}):e.jsx(F,{to:"/login",className:t.newTopicBtn,children:"Login to Post"})]}),m.length>0?e.jsx("div",{className:t.topicsList,children:m.map(s=>e.jsxs("div",{className:t.topicCard,onClick:()=>D(s.id),children:[e.jsx("div",{className:t.topicHeader,children:e.jsxs("span",{className:t.topicTitle,children:[s.is_pinned&&e.jsxs("span",{className:t.pinnedBadge,children:[e.jsx(J,{size:10})," Pinned"]}),s.title]})}),e.jsxs("div",{className:t.topicMeta,children:[e.jsxs("span",{children:["by ",s.author?.full_name||"Anonymous"]}),e.jsxs("span",{className:t.topicStats,children:[e.jsxs("span",{className:t.topicStat,children:[e.jsx(E,{size:14})," ",s.view_count||0]}),e.jsxs("span",{className:t.topicStat,children:[e.jsx(L,{size:14})," ",s.posts?.[0]?.count||0]}),e.jsxs("span",{className:t.topicStat,children:[e.jsx(Z,{size:14})," ",P(s.created_at)]})]})]})]},s.id))}):e.jsxs("div",{className:t.emptyState,children:[e.jsx(S,{size:48}),e.jsx("h3",{children:"No topics yet"}),e.jsx("p",{children:"Be the first to start a discussion in this category!"})]})]}),le=()=>e.jsxs("div",{className:t.topicPage,children:[e.jsxs("div",{className:t.breadcrumb,children:[e.jsx("a",{href:"#",onClick:s=>{s.preventDefault(),c("categories")},children:"Forum"}),e.jsx(M,{size:14}),e.jsx("a",{href:"#",onClick:s=>{s.preventDefault(),K(u?.category?.slug||"general")},children:u?.category?.name||"Category"}),e.jsx(M,{size:14}),e.jsxs("span",{children:[u?.title?.slice(0,30),"..."]})]}),e.jsxs("div",{className:t.topicContent,children:[e.jsx("h1",{style:{fontSize:"1.5rem",marginBottom:"1rem",color:"var(--text-primary)"},children:u?.title}),e.jsxs("div",{className:t.topicAuthor,children:[e.jsx("div",{className:t.avatar,children:V(u?.author?.full_name)}),e.jsxs("div",{className:t.authorInfo,children:[e.jsx("span",{className:t.authorName,children:u?.author?.full_name||"Anonymous"}),e.jsx("span",{className:t.authorDate,children:P(u?.created_at)})]})]}),e.jsx("div",{className:t.topicBody,children:e.jsx("p",{children:u?.content})}),e.jsxs("div",{className:t.topicActions,children:[e.jsxs("button",{className:t.actionBtn,children:[e.jsx(_e,{size:16})," Like"]}),e.jsxs("span",{className:t.topicStat,children:[e.jsx(E,{size:14})," ",u?.view_count||0," views"]})]})]}),e.jsxs("div",{className:t.repliesSection,children:[e.jsxs("h3",{children:[w.length," Replies"]}),w.map(s=>e.jsxs("div",{className:`${t.replyCard} ${s.is_solution?t.solution:""}`,children:[e.jsxs("div",{className:t.topicAuthor,children:[e.jsx("div",{className:t.avatar,children:V(s.author?.full_name)}),e.jsxs("div",{className:t.authorInfo,children:[e.jsxs("span",{className:t.authorName,children:[s.author?.full_name||"Anonymous",s.is_solution&&e.jsxs("span",{className:t.solutionBadge,children:[e.jsx(xe,{size:10})," Solution"]})]}),e.jsx("span",{className:t.authorDate,children:P(s.created_at)})]})]}),e.jsx("div",{className:t.topicBody,children:e.jsx("p",{children:s.content})})]},s.id)),a?e.jsxs("form",{className:t.replyForm,onSubmit:ce,children:[e.jsx("h4",{children:"Write a Reply"}),e.jsx("textarea",{placeholder:"Share your thoughts...",value:B,onChange:s=>W(s.target.value),required:!0}),e.jsxs("button",{type:"submit",className:t.submitReply,disabled:T||!B.trim(),children:[T?e.jsx(I,{size:18,className:t.loading}):e.jsx(ee,{size:18}),"Post Reply"]})]}):e.jsxs("div",{className:t.loginPrompt,children:[e.jsx("p",{children:"You need to be logged in to reply."}),e.jsx(F,{to:"/login",children:"Login to participate"})]})]})]}),de=()=>e.jsx("div",{className:t.modal,onClick:()=>N(!1),children:e.jsxs("div",{className:t.modalContent,onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:t.modalHeader,children:[e.jsx("h2",{children:"Create New Topic"}),e.jsx("button",{className:t.closeBtn,onClick:()=>N(!1),children:e.jsx(ge,{size:20})})]}),e.jsxs("form",{onSubmit:re,children:[e.jsxs("div",{className:t.modalBody,children:[e.jsxs("div",{className:t.formGroup,children:[e.jsx("label",{children:"Category"}),e.jsxs("select",{value:x.categoryId,onChange:s=>C({...x,categoryId:s.target.value}),required:!0,children:[e.jsx("option",{value:"",children:"Select a category"}),r.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{className:t.formGroup,children:[e.jsx("label",{children:"Title"}),e.jsx("input",{type:"text",placeholder:"What's your question or topic?",value:x.title,onChange:s=>C({...x,title:s.target.value}),required:!0,maxLength:200})]}),e.jsxs("div",{className:t.formGroup,children:[e.jsx("label",{children:"Content"}),e.jsx("textarea",{placeholder:"Provide details, context, or your thoughts...",value:x.content,onChange:s=>C({...x,content:s.target.value}),required:!0})]})]}),e.jsxs("div",{className:t.modalFooter,children:[e.jsx("button",{type:"button",className:t.cancelBtn,onClick:()=>N(!1),children:"Cancel"}),e.jsxs("button",{type:"submit",className:t.submitBtn,disabled:T,children:[T?e.jsx(I,{size:18}):e.jsx(ee,{size:18}),"Create Topic"]})]})]})]})});return te&&o==="categories"?e.jsx("div",{className:t.container,children:e.jsx("div",{className:t.loading,children:e.jsx(I,{size:32})})}):e.jsxs("div",{className:t.container,children:[o==="categories"&&ie(),o==="category"&&ne(),o==="topic"&&le(),ae&&de()]})},Ft=()=>e.jsx(bt,{});export{Ft as default};
